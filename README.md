# 基于IEC-61131 ST语言的编程上位机

配合STVM进行程序开发，使用跨平台Qt6框架作为核心基础

## 核心功能模块

### 1. 代码编辑器核心
- ST语言语法高亮和着色
- 代码智能提示和自动补全
- 实时语法检查和错误提示
- 代码格式化和自动缩进
- 查找/替换、代码折叠
- 多文档标签页管理

### 2. POU管理(程序组织单元)
- PROGRAM(程序)编辑和管理
- FUNCTION(函数)定义和调用
- FUNCTION_BLOCK(功能块)开发
- 变量声明管理(VAR, VAR_INPUT, VAR_OUTPUT, VAR_IN_OUT, VAR_TEMP)
- 数据类型定义(STRUCT, ENUM, ARRAY, TYPE)

### 3. 工程项目管理
- 工程创建、打开、保存
- 项目文件树形结构管理
- 算法库(Library)的引用和管理
- 工程配置(目标设备、编译选项)
- 工程导入/导出(.zip打包)

### 4. 编译器与代码生成
- ST语言词法分析和语法分析
- 中间代码生成(IR)
- 针对STVM的字节码生成
- 编译错误和警告提示
- 编译优化选项

### 5. 设备通讯与下装
- 设备连接管理(串口/TCP/UDP)
- 程序下载到STVM
- 程序上传(读取设备程序)
- 固件版本检测和更新
- 连接状态监控

### 6. 在线调试核心
- 变量实时监视(Watch)
- 变量强制功能(Force)
- 断点设置和管理
- 单步执行(Step Into/Over/Out)
- 运行/暂停/停止控制
- 调用栈查看

### 7. 插件架构基础
- 插件接口定义(Plugin API)
- 插件加载和卸载机制
- 插件生命周期管理
- 插件配置和权限管理
- 事件总线/消息机制

## 扩展功能(插件/微服务模式)

### 图形化编程插件
- 梯形图(LD)编辑器插件
- 功能块图(FBD)编辑器插件
- 顺序功能图(SFC)编辑器插件
- 图形与ST代码互转

### 调试增强插件
- 数据趋势图显示
- 历史数据记录和回放
- 性能分析和CPU占用监控
- 内存使用分析
- 扫描周期统计

### HMI界面设计插件
- 可视化界面设计器
- 控件库(按钮、指示灯、仪表等)
- 变量绑定和动画效果
- 运行时HMI渲染引擎

### 仿真测试插件
- 离线仿真器(无需硬件)
- 虚拟IO模拟
- 测试用例管理
- 自动化测试框架
- 覆盖率分析

### 通讯协议插件
- Modbus TCP/RTU通讯插件
- OPC UA客户端/服务器插件
- EtherNet/IP插件
- MQTT插件
- 自定义协议扩展

### 数据服务(微服务)
- 历史数据库服务(InfluxDB/TimescaleDB)
- 实时数据缓存服务(Redis)
- 报警服务(告警规则引擎)
- 数据导出服务(CSV/Excel/PDF)

### 文档与协作插件
- 代码注释自动生成文档
- 项目文档管理
- 版本控制集成(Git)
- 多人协作和冲突解决
- 代码审查工具

### 安全与权限插件
- 用户认证和授权服务
- 角色权限管理(RBAC)
- 操作审计日志
- 程序加密保护
- 数字签名验证

### AI辅助插件
- 代码智能补全(基于AI)
- 代码质量分析和建议
- 自动生成测试用例
- 故障诊断助手

### 其他工具插件
- 脚本扩展(Python/Lua)
- 自定义代码模板
- 代码片段管理
- 快捷键自定义
- 主题和界面定制

## 技术架构

### 核心层
- Qt6 框架(UI和跨平台支持)
- 编译器前端(Lexer/Parser)
- STVM通讯协议栈
- 插件管理器

### 插件层
- 基于Qt插件系统或自定义插件框架
- 支持C++和Python插件开发
- 插件间通过事件总线通讯

### 微服务层(可选)
- RESTful API或gRPC接口
- 容器化部署(Docker)
- 服务发现和负载均衡
- 消息队列(RabbitMQ/Kafka)

## 开发路线图

### Phase 1: 核心MVP (最小可行产品)
- 代码编辑器 + 基础POU管理
- 简单编译器和代码生成
- 设备连接和程序下装
- 基础变量监视

### Phase 2: 完善核心功能
- 完整的调试功能
- 工程管理优化
- 插件架构实现
- 第一批官方插件

### Phase 3: 生态建设
- 更多插件开发
- 微服务架构搭建
- 开放插件SDK
- 社区和文档建设

## 快速开始

### 构建项目

```bash
# 安装依赖 (Ubuntu/Debian)
sudo apt install qt6-base-dev qt6-serialport-dev libspdlog-dev cmake build-essential

# 编译
./build.sh

# 运行
./build/NasCode
```

### 项目结构

详细架构文档请参阅 [ARCHITECTURE.md](ARCHITECTURE.md)

## 技术栈总结

### 核心框架
- **Qt6** - 跨平台UI框架,提供成熟的MVC支持
- **MVC架构** - Model-View-Controller设计模式,提高可维护性
- **插件系统** - 基于Qt插件机制,支持功能扩展
- **事件总线** - 组件间解耦通信
- **spdlog** - 高性能日志库

### 推荐集成的成熟框架
- **QScintilla** - 强大的代码编辑器组件(语法高亮、代码折叠)
- **ANTLR4** - 编译器前端(词法/语法分析器生成器)
- **Qt Model/View** - 内置的数据-视图分离架构
- **Qt6::SerialPort** - 串口通讯
- **Qt6::Network** - TCP/UDP通讯
- **nlohmann/json** - JSON配置解析

## 已实现功能

### ✅ 核心框架层
- [x] MVC架构基础搭建
- [x] 应用程序单例管理(Application)
- [x] 事件总线(EventBus)
- [x] 插件管理系统(PluginManager)
- [x] 插件接口定义(IPlugin)

### ✅ Model层(数据模型)
- [x] 工程数据模型(Project)
- [x] POU数据模型(Program/Function/FunctionBlock)
- [x] 变量声明管理
- [x] Qt Model/View集成(ProjectModel)
- [x] 工程序列化(JSON)

### ✅ View层(用户界面)
- [x] 主窗口框架(MainWindow)
- [x] ST语言代码编辑器(CodeEditor)
- [x] 语法高亮(STSyntaxHighlighter)
- [x] 行号显示
- [x] 当前行高亮
- [x] 输出面板(BuildOutput/DebugOutput)
- [x] 菜单和工具栏
- [x] 停靠窗口(Dock)

### ✅ Controller层(业务逻辑)
- [x] 工程控制器(ProjectController)
- [x] Model-View协调逻辑
- [x] 事件处理

## MVC架构优势

1. **Model(模型)独立** - 业务逻辑与界面分离,可独立测试
2. **View(视图)可替换** - 可以轻松切换界面风格,支持多平台
3. **Controller(控制器)解耦** - 协调逻辑清晰,易于维护
4. **代码复用性高** - Model可以被多个View使用
5. **易于扩展** - 通过插件系统进一步解耦

## 文档

- [架构文档](ARCHITECTURE.md) - 详细的系统架构和设计说明
- [插件开发指南](docs/PLUGIN_DEVELOPMENT.md) - 如何开发自定义插件

## 下一步开发建议

1. **集成QScintilla** - 替换基础编辑器,获得更强大的编辑功能
2. **实现ANTLR4语法** - 定义ST语言语法,生成词法/语法分析器
3. **完善编译器** - 实现完整的编译链路
4. **通讯协议** - 实现与STVM的通讯协议
5. **插件示例** - 开发第一个官方插件

## 许可证

待定
